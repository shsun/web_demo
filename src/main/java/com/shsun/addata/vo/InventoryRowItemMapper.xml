<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd" >
<mapper
	namespace="com.shsun.addata.vo.InventoryRowItemMapper">

	<resultMap id="BaseResultMap"
		type="com.shsun.addata.vo.InventoryRowItem">
		<result column="DATE_TIME" property="DATE_TIME" jdbcType="TIMESTAMP" />
		<result column="DATE_ID" property="DATE_ID" jdbcType="DECIMAL" />
		<result column="SITE_ID" property="SITE_ID" jdbcType="DECIMAL" />
		<result column="MOBILE_SEGMENT_ID" property="MOBILE_SEGMENT_ID"
			jdbcType="DECIMAL" />
		<result column="CHANNEL_AGENT_ID" property="CHANNEL_AGENT_ID" jdbcType="DECIMAL" />
		<result column="SUB_CHANNEL_AGENT_ID" property="SUB_CHANNEL_AGENT_ID"
			jdbcType="DECIMAL" />
		<result column="PROVINCE_ID" property="PROVINCE_ID" jdbcType="DECIMAL" />
		<result column="CITY_ID" property="CITY_ID" jdbcType="DECIMAL" />
		<result column="SLOT_ID" property="SLOT_ID" jdbcType="DECIMAL" />
		<result column="PREDEFINED1" property="PREDEFINED1" jdbcType="DECIMAL" />
		<result column="PREDEFINED2" property="PREDEFINED2" jdbcType="DECIMAL" />
		<result column="RADI" property="RADI" jdbcType="DECIMAL" />
		
		<result column="VIDEO_LENGTH_ID" property="VIDEO_LENGTH_ID" jdbcType="DECIMAL" />
		<!--  -->
		<result column="HOUR_ID" property="HOUR_ID" jdbcType="DECIMAL" />
		<!--  -->
		<result column="SLOT_NAME" property="SLOT_NAME" jdbcType="VARCHAR" />
		<result column="PROVINCE_NAME" property="PROVINCE_NAME" jdbcType="VARCHAR" />
		<result column="CITY_NAME" property="CITY_NAME" jdbcType="VARCHAR" />
		<result column="CHANNEL_NAME" property="CHANNEL_NAME" jdbcType="VARCHAR" />
		<result column="SUB_CHANNEL_NAME" property="SUB_CHANNEL_NAME" jdbcType="VARCHAR" />		
	</resultMap>
	
	<!-- $里面的是静态SQL，#是动态SQL -->
	<select id="countBy" parameterType="com.shsun.addata.vo.InventorySqlParameterSource" statementType="STATEMENT" resultType="int"> 
		<![CDATA[ SELECT COUNT(1) FROM ${TABLE_NAME} driver]]>
		<include refid="whereCondition" />
	</select>
	
	<select id="mcountBy" parameterType="com.shsun.addata.vo.InventorySqlParameterSource" statementType="STATEMENT" resultType="int"> 
		<![CDATA[ SELECT COUNT(1) FROM ${TABLE_NAME} driver, DIM_ADS_MOBILE_SEG seg, DIM_ADS_SLOT slot ]]>
		<include refid="mwhereCondition" />
	</select>
	
	<select id="gcountBy" parameterType="com.shsun.addata.vo.InventorySqlParameterSource" statementType="STATEMENT" resultType="int">   
		<![CDATA[ select count(1) from (select ]]>
		<foreach item="pro" index="index" collection="DRIVER_GROUP_BY_PROPERTIES.getProperties()" open="" separator="," close=",">
			<![CDATA[ ${pro} ]]>
  		</foreach> 
		<![CDATA[ count(1) from ${TABLE_NAME} driver ]]>
		<include refid="whereCondition" />
		<![CDATA[ group by ]]>
		<foreach item="pro" index="index" collection="DRIVER_GROUP_BY_PROPERTIES.getProperties()" open="" separator="," close=")">
			<![CDATA[ ${pro} ]]>
  		</foreach> 
	</select>
	
	<select id="mgcountBy" parameterType="com.shsun.addata.vo.InventorySqlParameterSource" statementType="STATEMENT" resultType="int">   
		<![CDATA[ select count(1) from (select ]]>
		<include refid="groupbyedProperties" /> 
		<![CDATA[, count(1) from ${TABLE_NAME} driver, DIM_ADS_MOBILE_SEG seg,DIM_ADS_SLOT slot ]]>
		<include refid="mwhereCondition" />
		<![CDATA[ group by ]]>
		<include refid="groupbyedProperties" />
		<![CDATA[)]]>
	</select>
	
	<select id="retrievePage" parameterType="com.shsun.addata.vo.InventorySqlParameterSource" statementType="STATEMENT" resultMap="BaseResultMap"> 
		<![CDATA[ 
			SELECT t2.SLOT_ID,]]>
			<if test="level!=null and level=='HOUR'">
				<![CDATA[ t2.HOUR_ID, ]]>
			</if>
		<![CDATA[t2.SITE_ID,]]>
		<![CDATA[ t2.CHANNEL_AGENT_ID, ]]>
		<if test="TABLE_NAME=='DW_ADS_ADI_DAY' or TABLE_NAME=='DW_ADS_ADI_HOUR'">
			<![CDATA[ t2.SUB_CHANNEL_AGENT_ID, ]]>
		</if>
		<![CDATA[t2.PROVINCE_ID,]]>			
		<if test="TABLE_NAME=='DW_ADS_ADI_DAY' or TABLE_NAME=='DW_ADS_ADI_CITY_CHANNEL_DAY' or TABLE_NAME=='DW_ADS_ADI_HOUR'">
			<![CDATA[ t2.CITY_ID, ]]>
		</if>			
		<![CDATA[t2.DATE_TIME, t2.VIDEO_LENGTH_ID,
			round((case when t2.DATE_TIME<to_date('20130305','yyyy-mm-dd') and t2.SLOT_ID=2 then t2.RADI*1 when t2.SLOT_ID=2 then t2.RADI*1 else t2.RADI end)) as RADI
		FROM 
			(select 
				t1.*, ROWNUM ROWNUM_ 
			FROM 
				(select * 
				FROM 
					${TABLE_NAME} driver
		]]>
				<include refid="whereCondition" />
					order by driver.DATE_TIME desc, driver.RADI desc ) t1
			<where>
				<![CDATA[ ROWNUM <= ${END_ROW} ) t2 ]]>
			</where> 
		<where>
			<![CDATA[ ROWNUM_ >${START_ROW} ]]>	
		</where>		
	</select>
	
	<select id="mretrievePage" parameterType="com.shsun.addata.vo.InventorySqlParameterSource" statementType="STATEMENT" resultMap="BaseResultMap"> 
		<![CDATA[
		SELECT t2.SLOT_ID,t2.MOBILE_SEGMENT_ID, ]]>
			<if test="level!=null and level=='HOUR'">
				<![CDATA[ t2.HOUR_ID, ]]>
			</if>
		<![CDATA[
			t2.VIDEO_LENGTH_ID,
			t2.SITE_ID,
			t2.CHANNEL_AGENT_ID,
			t2.PROVINCE_ID,
			t2.CITY_ID,
			t2.DATE_TIME,
			t2.VIDEO_LENGTH_ID, 
			round((case when t2.SLOT_ID=2 then t2.RADI*1 else t2.RADI end)) as RADI,
			t2.TYPE_ID 
		FROM 
			(select 
				t1.*, ROWNUM ROWNUM_ 
			FROM 
				(select 
					 driver.SLOT_ID,driver.MOBILE_SEGMENT_ID,]]>
					<if test="level!=null and level=='HOUR'">
						<![CDATA[ driver.HOUR_ID, ]]>
					</if>
					<![CDATA[
					driver.VIDEO_LENGTH_ID,
					driver.SITE_ID,
					driver.CHANNEL_AGENT_ID,
					driver.PROVINCE_ID,
					driver.CITY_ID,
					driver.DATE_TIME, 
					driver.RADI,
					slot.TYPE_ID 
					]]>
				<![CDATA[
				FROM 
					${TABLE_NAME} driver, DIM_ADS_MOBILE_SEG seg, DIM_ADS_SLOT slot 
				]]>
				<include refid="mwhereCondition" />
					order by driver.DATE_TIME desc, driver.RADI desc ) t1
			<where>
				<![CDATA[ ROWNUM <= ${END_ROW} ) t2 ]]>
			</where> 
		<where>
			<![CDATA[ ROWNUM_ >${START_ROW} ]]>	
		</where>		
	</select>
		
	
	<select id="gretrievePage" parameterType="com.shsun.addata.vo.InventorySqlParameterSource" statementType="STATEMENT" resultMap="BaseResultMap">
		<![CDATA[ SELECT ]]>
		<foreach item="pro" index="index" collection="DRIVER_GROUP_BY_PROPERTIES.getProperties()" open="" separator="," close=",">
			<![CDATA[ t2.${pro} ]]>
  		</foreach>		
		<![CDATA[ round(t2.RADI) as RADI FROM (select t1.* , ROWNUM ROWNUM_ 
		from 
		(select ]]>
			<foreach item="pro" index="index" collection="DRIVER_GROUP_BY_PROPERTIES.getProperties()" open="" separator="," close="">
				<![CDATA[ driver.${pro} ]]>
  			</foreach>
  			<![CDATA[, sum( (case when driver.DATE_TIME<to_date('20130305','yyyy-mm-dd') and driver.SLOT_ID=2 and driver.video_length_id=1 then driver.RADI*2.3 when driver.slot_id=3 then 0 when driver.slot_id=9 then 0 when driver.slot_id=20 then 0 when driver.slot_id=2 and driver.video_length_id=1 then driver.RADI*2.7 else driver.RADI end) ) as RADI from ${TABLE_NAME} driver ]]>
				<include refid="whereCondition" />
		group by 
		<foreach item="pro" index="index" collection="DRIVER_GROUP_BY_PROPERTIES.getProperties()" open="" separator="," close="">
			<![CDATA[ driver.${pro} ]]>
  		</foreach> 
  		<![CDATA[ order by RADI desc ) t1 where ROWNUM <= ${END_ROW} ) t2 where ROWNUM_ >${START_ROW} ]]>
	</select>
	
	
	
	<select id="mgretrievePage" parameterType="com.shsun.addata.vo.InventorySqlParameterSource" statementType="STATEMENT" resultMap="BaseResultMap">
		<![CDATA[ SELECT ]]>
		<include refid="selectedProperties" />		
		<![CDATA[, round(t2.RADI) as RADI FROM (select t1.* , ROWNUM ROWNUM_ 
		from 
		(select ]]>
			<include refid="groupbyedProperties" />
  			<![CDATA[, sum( (case when driver.slot_id=3 then 0 when driver.slot_id=9 then 0 when driver.slot_id=20 then 0 when driver.slot_id=2 then driver.RADI*1 else driver.RADI end) ) as RADI from ${TABLE_NAME} driver, DIM_ADS_MOBILE_SEG seg,DIM_ADS_SLOT slot ]]>
 				<include refid="mwhereCondition" />
		group by 
		<include refid="groupbyedProperties" />
  		<![CDATA[ order by RADI desc ) t1 where ROWNUM <= ${END_ROW} ) t2 where ROWNUM_ >${START_ROW} ]]>
	</select>
	
	<sql id="selectedProperties">
		<foreach item="pro" index="index" collection="GROUP_BY_PROPERTIES" open="" separator="," close="">
				<![CDATA[t2.${pro}]]>
  		</foreach>
	</sql>
	
	<sql id="groupbyedProperties">
		<foreach item="pro" index="index" collection="GROUP_BY_ALIASED_PROPERTIES" open="" separator="," close="">
				<![CDATA[${pro}]]>
  		</foreach>
	</sql>
	
	<sql id="mwhereCondition">  
		<where> 
			<include refid="commonWhereCondition" />
			<if test="CHANNEL_AGENT_ID!=null and CHANNEL_AGENT_ID!=''">
				<![CDATA[ AND driver.CHANNEL_AGENT_ID in ${CHANNEL_AGENT_ID} ]]>
			</if>
			<if test="SUB_CHANNEL_AGENT_ID!=null and SUB_CHANNEL_AGENT_ID!=''">
				<![CDATA[ AND driver.SUB_CHANNEL_AGENT_ID in ${SUB_CHANNEL_AGENT_ID} ]]>
			</if>
			<if test="VIDEO_LENGTH_ID!=null and VIDEO_LENGTH_ID!=''">
				<![CDATA[ AND driver.VIDEO_LENGTH_ID = ${VIDEO_LENGTH_ID} ]]>
			</if>
			<if test="MOBILE_SEGMENT_ID!=null and MOBILE_SEGMENT_ID!=''">
				<![CDATA[ AND driver.MOBILE_SEGMENT_ID in ${MOBILE_SEGMENT_ID} ]]>
			</if>
			<if test="MOBILE_SEGMENT_ID!=null and MOBILE_SEGMENT_ID!=''">
				<![CDATA[ AND driver.MOBILE_SEGMENT_ID = seg.MOBILE_SEGMENT_ID ]]>
			</if>
			<![CDATA[ AND driver.SLOT_ID = slot.SLOT_ID ]]>
		</where>
	</sql>	

	<sql id="whereCondition">
		<where> 
			<include refid="commonWhereCondition" />
			<if test="HOUR_ID!=null and HOUR_ID!=''">
				<![CDATA[ AND driver.HOUR_ID in ${HOUR_ID} ]]>
			</if>
		</where>
	</sql>
	
	<sql id="commonWhereCondition">
			<![CDATA[ 1=1 ]]> 
			<if test="START_DATE!=null and START_DATE!=''">
				<![CDATA[ AND driver.DATE_TIME >= to_date('${START_DATE}', 'RR-MM-DD') ]]>
			</if>
			<if test="END_DATE!=null and END_DATE!=''">
				<![CDATA[ AND driver.DATE_TIME <= to_date('${END_DATE}', 'RR-MM-DD') ]]>
			</if>
			<if test="SLOT_ID!=null and SLOT_ID!=''">
				<![CDATA[ AND driver.SLOT_ID in ${SLOT_ID} ]]>
			</if>
			<if test="VIDEO_LENGTH_ID!=null and VIDEO_LENGTH_ID!=''">
				<![CDATA[ AND driver.VIDEO_LENGTH_ID=${VIDEO_LENGTH_ID} ]]>
			</if>
			<if test="SITE_ID!=null and SITE_ID!=''">
				<![CDATA[ AND driver.SITE_ID = ${SITE_ID} ]]>
			</if>
			<if test="PROVINCE_ID!=null and PROVINCE_ID!=''">
				<![CDATA[ AND driver.PROVINCE_ID in ${PROVINCE_ID} ]]>
			</if>
			<if test="CITY_ID!=null and CITY_ID!=''">
				<![CDATA[ AND driver.CITY_ID in ${CITY_ID} ]]>
			</if>
			<if test="CHANNEL_AGENT_ID!=null and CHANNEL_AGENT_ID!=''">
				<![CDATA[ AND driver.CHANNEL_AGENT_ID in ${CHANNEL_AGENT_ID} ]]>
			</if>
			<if test="SUB_CHANNEL_AGENT_ID!=null and SUB_CHANNEL_AGENT_ID!=''">
				<![CDATA[ AND driver.SUB_CHANNEL_AGENT_ID in ${SUB_CHANNEL_AGENT_ID} ]]>
			</if>
	</sql>
	
</mapper>